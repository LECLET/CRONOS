<!DOCTYPE html><html lang="fr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CRONOS V8</title><style>:root{--bg:#0f172a;--panel:#111827;--muted:#9aa4b2;--accent:#2563eb;--accent-2:#1e40af;--text:#e5e7eb}
*{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Noto Sans;background:#0b1020;color:var(--text)}
.topbar{height:72px;background:#0b1020;border-bottom:1px solid #1f2937;display:flex;align-items:center;justify-content:space-between;padding:0 20px;gap:16px}
.brand{display:flex;align-items:center;gap:12px;font-weight:700;letter-spacing:1px}
.brand img{width:40px;height:40px}
.userbox{display:flex;align-items:center;gap:10px;color:var(--muted)}
.navbar{background:#0b1020;border-bottom:1px solid #1f2937;display:flex;gap:8px;padding:8px 12px;overflow-x:auto}
.navlink{padding:10px 14px;border-radius:10px;color:var(--text);text-decoration:none;border:1px solid transparent;white-space:nowrap}
.navlink:hover{background:#0f172a;border-color:#1f2937}.navlink.active{background:#111827;border-color:#1f2937}
.page-container{padding:18px}
.card{background:#0b1020;border:1px solid #1f2937;border-radius:14px;padding:16px;margin-bottom:14px}
.btn-primary{padding:10px 14px;border:none;border-radius:10px;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;cursor:pointer}
.btn-ghost{padding:8px 12px;border-radius:10px;background:transparent;border:1px solid #1f2937;color:var(--text);cursor:pointer}
input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #1f2937;background:#0b1020;color:var(--text)}
.hint{font-size:12px;color:var(--muted)}
table{width:100%;border-collapse:collapse}th,td{border:1px solid #1f2937;padding:6px}th{text-align:left;background:#0f172a}
.badge{display:inline-block;padding:4px 8px;border-radius:999px;background:#111827;border:1px solid #1f2937;color:var(--muted);font-size:12px}</style></head>
<body>
<header class="topbar">
  <div class="brand"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mP8Xw8AApEBQ/9Xq2wAAAAASUVORK5CYII=" alt="LOGO"/><span>CRONOS</span></div>
  <nav class="navbar">
    <a href="#/commercial" class="navlink">üíº GESTION COMMERCIALE</a>
    <a href="#/agents" class="navlink">üë§ AGENTS</a>
    <a href="#/planifications" class="navlink">üìÖ PLANIFICATION</a>
    <a href="#/internet" class="navlink">üåê INTERNET</a>
    <a href="#/param" class="navlink">‚öôÔ∏è PARAM√âTRAGES</a>
  </nav>
  <div class="userbox"><span id="u-info">demo ‚Ä¢ AUTRE</span><button class="btn-ghost" id="logout">D√©connexion</button></div>
</header>
<main id="page" class="page-container"></main>
<script>
const $=(s)=>document.querySelector(s);
const PAGES={"/commercial":"<div class='card'><h2>Gestion commerciale</h2><p>(placeholder)</p></div>","/agents":"<div class='card'><h2>Agents</h2><p>(placeholder)</p></div>","/planifications":"<div class='card'><h2>Planification</h2><p>Chargement‚Ä¶</p><div class='card'><button class='btn-ghost' id='seed'>Injecter donn√©es de test</button></div></div>","/internet":"<div class='card'><h2>Internet</h2><p>(placeholder)</p></div>","/param":"<div class='card'><h2>Param√©trages</h2><p>(placeholder)</p></div>"}
function route(){ const r=location.hash||"#/planifications"; document.querySelectorAll(".navlink").forEach(a=>a.classList.toggle("active", a.getAttribute("href")===r)); document.getElementById("page").innerHTML=PAGES[r.replace("#","")]||"<div class='card'><h2>Page</h2></div>"; }
window.addEventListener("hashchange", route); route();
</script>
<script>

const SITE_KEY='cronos_sites_v1', PRE_KEY='cronos_prestations_v1', VAC_KEY='cronos_vacations_v1', TRM_KEY='cronos_trame_v1', PLN_KEY='cronos_planning_v1', AGENTS_KEY='cronos_agents_v1';
function lsGet(k){ try{return JSON.parse(localStorage.getItem(k)||'[]');}catch{return[];} } function lsSet(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function uid(){ return String(Date.now())+Math.random(); }
function isoWeekStart(ds){ const d=new Date(ds||new Date().toISOString().slice(0,10)); const w=d.getDay(); const diff=(w===1)?0:(w===0?-6:1-w); d.setDate(d.getDate()+diff); d.setHours(0,0,0,0); return d.toISOString().slice(0,10); }
function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function fmtDate(d){ return d.toISOString().slice(0,10); }
function getPlan(siteId, weekStartISO){ const arr=lsGet(PLN_KEY); return arr.find(p=>p.siteId===siteId && p.weekStartISO===weekStartISO); }
function agentById(id){ return lsGet(AGENTS_KEY).find(a=>a.id===id); }
function pr_refreshAgentOptions(){ const sel=document.getElementById('pr-agent'); if(!sel) return; const arr=lsGet(AGENTS_KEY); sel.innerHTML = arr.map(a=>`<option value="${a.id}">${(a.last||'').toUpperCase()} ${a.first||''} ‚Ä¢ ${a.mat||''}</option>`).join(''); }
function pr_bind(){ const mode=document.getElementById('pr-mode'); const range=document.getElementById('pr-range'); const ac=document.getElementById('pr-agent-col'); const wc=document.getElementById('pr-week-col'); const mc=document.getElementById('pr-month-col'); const fc=document.getElementById('pr-from-col'); const tc=document.getElementById('pr-to-col'); function sync(){ ac.style.display=(mode.value==='agent')?'block':'none'; wc.style.display=(range.value==='week')?'block':'none'; mc.style.display=(range.value==='month')?'block':'none'; const cust=(range.value==='custom'); fc.style.display=cust?'block':'none'; tc.style.display=cust?'block':'none'; } mode.onchange=sync; range.onchange=sync; document.getElementById('pr-week').value=isoWeekStart(); document.getElementById('pr-month').value=new Date().toISOString().slice(0,7); document.getElementById('pr-from').value=new Date().toISOString().slice(0,10); document.getElementById('pr-to').value=new Date().toISOString().slice(0,10); sync(); }
function pr_range(){ const r=document.getElementById('pr-range').value; if(r==='week'){ const ws=document.getElementById('pr-week').value; const start=new Date(ws); const end=addDays(start,6); return {start,end}; } else if(r==='month'){ const ym=document.getElementById('pr-month').value; const start=new Date(ym+'-01'); const end=new Date(start); end.setMonth(end.getMonth()+1); end.setDate(0); return {start,end}; } else { const start=new Date(document.getElementById('pr-from').value); const end=new Date(document.getElementById('pr-to').value); return {start,end}; } }
function preIdx(){ return Object.fromEntries(lsGet(PRE_KEY).map(p=>[p.id,p])); } function vacIdx(){ return Object.fromEntries(lsGet(VAC_KEY).map(v=>[v.id,v])); }
function pr_collect(siteId, start, end){ const pIdx=preIdx(), vIdx=vacIdx(); const days=[]; for(let d=new Date(start); d<=end; d=addDays(d,1)) days.push(new Date(d)); const out=[]; for(const d of days){ const dow=d.getDay(); const ws=isoWeekStart(fmtDate(d)); const plan=getPlan(siteId, ws); const items=[]; if(plan){ for(const cid in plan.cells){ const [cd,preId,vacId,slot]=cid.split('_'); if(Number(cd)!==dow) continue; const asg=plan.cells[cid]; const ag=agentById(asg.agentId); const pre=pIdx[preId], vac=vIdx[vacId]; items.push({pre,vac,slot:Number(slot||0),agent:ag}); } } out.push({dateISO:fmtDate(d), day:dow, items}); } return out; }
function pr_print(){ const sess=JSON.parse(sessionStorage.getItem('sess')||'null'); const siteId = (localStorage.getItem('pl_current_site')||''); if(!siteId){ alert('S√©lectionnez un site (d√©mo bouton SEED).'); return; } const mode=document.getElementById('pr-mode').value; const {start,end}=pr_range(); const s=(lsGet('cronos_sites_v1').find(x=>x.id===siteId)||{{}}); const sname=s.name||''; const data=pr_collect(siteId, start, end); if(mode==='site'){ const win=window.open('','_blank'); let html='<!doctype html><html><head><meta charset=utf-8><title>Planning Site</title><style>body{{font-family:Arial;margin:22px}} table{{width:100%;border-collapse:collapse}} th,td{{border:1px solid #ddd;padding:6px}} th{{background:#f5f5f5}}</style></head><body>'; html+='<h1>Planning Site ‚Äî '+sname+'</h1><div>P√©riode : '+fmtDate(start)+' ‚Üí '+fmtDate(end)+'</div>'; for(const day of data){ html+='<h2>'+['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'][day.day]+' ‚Äî '+day.dateISO+'</h2>'; html+='<table><thead><tr><th>Profil</th><th>Vacation</th><th>Poste</th><th>Agent</th><th>Matricule</th></tr></thead><tbody>'; if(day.items.length===0) html+='<tr><td colspan=5 style="text-align:center;color:#777">Aucune affectation</td></tr>'; day.items.sort((a,b)=> (a.pre?.prof||'').localeCompare(b.pre?.prof||'')||(a.vac?.start||'').localeCompare(b.vac?.start||'')||(a.slot-b.slot)); for(const it of day.items){ const prof=it.pre?it.pre.prof:''; const vac=it.vac?(it.vac.code+' '+it.vac.start+'-'+it.vac.end):''; const ag=it.agent?((it.agent.last||'').toUpperCase()+' '+(it.agent.first||'')):'‚Äî'; const mat=it.agent?(it.agent.mat||''):''; html+='<tr><td>'+prof+'</td><td>'+vac+'</td><td>'+(1+(it.slot||0))+'</td><td>'+ag+'</td><td>'+mat+'</td></tr>'; } html+='</tbody></table>'; } html+='</body></html>'; win.document.write(html); win.document.close(); win.focus(); win.print(); } else { const agentId=document.getElementById('pr-agent').value; const ag=(lsGet(AGENTS_KEY).find(a=>a.id===agentId)||{{}}); const win=window.open('','_blank'); let html='<!doctype html><html><head><meta charset=utf-8><title>Planning Agent</title><style>body{{font-family:Arial;margin:22px}} table{{width:100%;border-collapse:collapse}} th,td{{border:1px solid #ddd;padding:6px}} th{{background:#f5f5f5}}</style></head><body>'; html+='<h1>Planning Agent ‚Äî '+((ag.last||'').toUpperCase()+' '+(ag.first||''))+'</h1><div>P√©riode : '+fmtDate(start)+' ‚Üí '+fmtDate(end)+' ‚Äî Site : '+sname+'</div>'; html+='<table><thead><tr><th>Date</th><th>Site</th><th>Profil</th><th>Vacation</th></tr></thead><tbody>'; for(const day of data){ const mine=day.items.filter(it=>it.agent && it.agent.id===agentId); mine.sort((a,b)=> (a.vac?.start||'').localeCompare(b.vac?.start||'')); for(const it of mine){ const prof=it.pre?it.pre.prof:''; const vac=it.vac?(it.vac.code+' '+it.vac.start+'-'+it.vac.end):''; html+='<tr><td>'+day.dateISO+'</td><td>'+sname+'</td><td>'+prof+'</td><td>'+vac+'</td></tr>'; } } html+='</tbody></table></body></html>'; win.document.write(html); win.document.close(); win.focus(); win.print(); } }
function seed(){ // quick demo data
  const siteId=uid(); const agentId=uid(); const preId=uid(); const vacId=uid();
  lsSet(SITE_KEY, [{{id:siteId,name:'SITE ALPHA',agency:'CASA',address:'Zone indus'}}]);
  lsSet(AGENTS_KEY, [{{id:agentId,last:'Amrani',first:'Youssef',mat:'A001',agency:'CASA'}}]);
  lsSet(PRE_KEY, [{{id:preId,siteId:siteId,act:'S√©curit√©',prof:'SSIAP1',unit:'h/j'}}]);
  lsSet(VAC_KEY, [{{id:vacId,siteId:siteId,code:'J',start:'08:00',end:'18:00',hours:10}}]);
  const ws=isoWeekStart(); const plan={{id:uid(),siteId:siteId,weekStartISO:ws,cells:{{}}}}; plan.cells['1_'+preId+'_'+vacId+'_0']={{agentId:agentId}}; plan.cells['2_'+preId+'_'+vacId+'_0']={{agentId:agentId}}; plan.cells['3_'+preId+'_'+vacId+'_0']={{agentId:agentId}}; const plans=lsGet(PLN_KEY); plans.push(plan); lsSet(PLN_KEY, plans); localStorage.setItem('pl_current_site', siteId); alert('Donn√©es de test inject√©es. Allez dans Impression pour imprimer.'); pr_refreshAgentOptions();
}
document.addEventListener('click',(e)=>{{ if(e.target?.id==='pr-print') pr_print(); if(e.target?.id==='seed') seed(); }});
const __r=(typeof route==='function')?route:()=>{{}};
route=function(){{ __r(); if((location.hash||'#/planifications')==='#/planifications'){{ document.getElementById('page').innerHTML=`{plan_ui}`; pr_refreshAgentOptions(); pr_bind(); }} }};

</script>
</body></html>