<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>CRONOS V9e12 — Suite complète</title>
<style>
:root{
  --bg:#0b1020;--panel:#0f152b;--line:#1f2937;--text:#e5e7eb;--muted:#9aa4b2;
  --ok:#16a34a;--bad:#ef4444;--warn:#f59e0b;--blue:#3b82f6;--yellow:#facc15;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
/* Topbar */
.top{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;border-bottom:1px solid var(--line);position:sticky;top:0;background:#0b1020;z-index:20}
.brand{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:1px}
.brand img{height:28px;width:auto;display:block}
.nav{display:flex;gap:10px;align-items:center}
.nav a{padding:8px 12px;border:1px solid var(--line);border-radius:999px;color:var(--text);text-decoration:none;background:#0d1224}
.nav a.active{background:linear-gradient(90deg,#2563eb,#1e40af);border:none}
.btn{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0b1020;color:var(--text);cursor:pointer}
.btn.warn{border-color:#7c2d12;background:#3f1d1d}
.card{border:1px solid var(--line);border-radius:12px;margin:12px;padding:12px;background:#0f152b}
.grid{display:grid;gap:12px}
input,select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:#0b1020;color:var(--text)}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
h2{margin:10px 12px}
.small{font-size:12px;color:var(--muted)}
.flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border-bottom:1px solid var(--line);text-align:left;font-size:14px}
.badge{display:inline-block;padding:2px 6px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:var(--muted)}
kbd{border:1px solid var(--line);padding:2px 6px;border-radius:6px;background:#0b1020;font-size:12px}
/* Planning grid */
.month{border:1px solid var(--line);border-radius:12px;overflow:auto}
:root{--first-col:320px}
.head,.row-header,.row-agent{display:grid;grid-template-columns:var(--first-col) repeat(31,1fr);min-width:1100px}
.head>div,.row-header>div,.row-agent>div{border-left:1px solid var(--line);padding:6px;font-size:12px;line-height:1.1}
.head>div:first-child,.row-header>div:first-child,.row-agent>div:first-child{border-left:none}
.row-header{background:#0d1224;border-top:1px solid var(--line)}
.row-agent{background:#0a0f20}
.cell{min-height:44px;position:relative}
.cell.drop{outline:2px dashed #334155;outline-offset:-2px}
.pill{display:inline-flex;flex-direction:column;align-items:flex-start;gap:2px;border:1px solid var(--line);border-radius:8px;padding:2px 6px;margin:3px 2px;font-size:12px;white-space:nowrap}
.pill.yellow{border-color:#4c4b22}
.pill.blue{border-color:#1b3a6d}
.pill.na{border-color:#7f1d1d;color:#fecaca;background:#3f1d1d}
.badge-na{display:inline-block;padding:2px 6px;border-radius:10px;border:1px solid #7f1d1d;background:#3f1d1d;color:#fecaca;font-size:11px;margin-left:8px}
/* Modal login */
#login{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:20px}
.sheet{background:#0f152b;border:1px solid var(--line);border-radius:12px;max-width:400px;width:100%;padding:16px}
/* Sections */
section{display:none}
section.active{display:block}
/* Recap top */
.recap-top{border:1px solid var(--line);border-radius:12px;padding:8px;overflow:auto}
.recap-grid{display:grid;grid-template-columns:140px 120px 80px 80px 70px 70px repeat(7,46px) 100px 110px 120px 140px 140px;gap:6px;min-width:1200px}
.recap-grid>div{font-size:12px}
.recap-grid .h{color:var(--muted)}
/* Sidebar agents */
.layout{display:grid;grid-template-columns:360px 1fr;gap:12px}
.left .agent{border:1px solid var(--line);border-radius:10px;padding:10px;margin-bottom:8px}
.left .agent .name{font-weight:600;cursor:pointer}
.left .agent .meta{font-size:12px;color:var(--muted);margin-top:4px}
/* Simple tags */
.tag{display:inline-block;padding:2px 6px;border-radius:999px;border:1px solid var(--line);font-size:12px}
.tag.green{color:#bbf7d0;border-color:#14532d;background:#052e16}
.tag.red{color:#fecaca;border-color:#7f1d1d;background:#3f1d1d}
/* Print */
@media print{.top,.print-hide{display:none !important}}
</style>
</head>
<body>

<div class="top">
  <div class="brand">
    <img src="logo_cronos.svg" alt="CRONOS"/>
    <span>CRONOS</span>
    <span class="badge">V9e12</span>
  </div>
  <div class="nav">
    <a href="#commercial" id="nav-commercial" class="active">Gestion commerciale</a>
    <a href="#agents" id="nav-agents">Agents</a>
    <a href="#planning" id="nav-planning">Planification</a>
    <a href="#internet" id="nav-internet">Internet</a>
    <a href="#params" id="nav-params">Paramétrages</a>
    <button class="btn" id="btn-logout">Déconnexion</button>
  </div>
</div>

<!-- GESTION COMMERCIALE -->
<section id="commercial" class="active">
  <h2>Gestion commerciale</h2>

  <div class="card grid" style="grid-template-columns:repeat(12,1fr)">
    <div style="grid-column:span 3">
      <label>Agence</label>
      <select id="c-agency"></select>
    </div>
    <div style="grid-column:span 3">
      <label>Client</label>
      <select id="c-client"></select>
      <div class="small">Statut : <span id="c-client-status" class="tag">—</span></div>
    </div>
    <div style="grid-column:span 4">
      <label>Site</label>
      <select id="c-site"></select>
    </div>
    <div style="grid-column:span 2;display:flex;align-items:flex-end">
      <button class="btn" id="btnNewNeed">+ Besoin</button>
    </div>
  </div>

  <div class="card grid" style="grid-template-columns:repeat(12,1fr)">
    <div style="grid-column:span 6">
      <h3 style="margin:0 0 8px 0">Clients</h3>
      <table class="table" id="tblClients">
        <thead><tr><th>Nom</th><th>Agence</th><th>Statut</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="flex">
        <input id="inClientName" placeholder="Nouveau client"/>
        <select id="inClientStatus">
          <option value="Client">Client</option>
          <option value="Prospect">Prospect</option>
        </select>
        <button class="btn" id="btnAddClient">Ajouter</button>
      </div>
    </div>
    <div style="grid-column:span 6">
      <h3 style="margin:0 0 8px 0">Sites (du client)</h3>
      <table class="table" id="tblSites">
        <thead><tr><th>Nom</th><th>Agence</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
      <div class="flex">
        <input id="inSiteName" placeholder="Nouveau site"/>
        <button class="btn" id="btnAddSite">Ajouter</button>
      </div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0">Besoins → Planification</h3>
    <table class="table" id="tblNeeds">
      <thead><tr>
        <th>Site</th><th>Profil</th><th>Catégorie</th><th>Début</th><th>Fin</th><th>Nb</th>
        <th>Jours</th><th>Maj. nuit</th><th>Maj. dim.</th><th>Maj. JF</th><th></th>
      </tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0">Devis & Facturation (bientôt)</h3>
    <div class="small">Placeholders : génération de devis/simulations, forfaits, facturation (vacations/forfaits), avoirs, règlements.</div>
  </div>
</section>

<!-- AGENTS -->
<section id="agents">
  <h2>Agents</h2>
  <div class="card grid" style="grid-template-columns:repeat(12,1fr)">
    <div style="grid-column:span 3">
      <label>Agence</label>
      <select id="a-agency"></select>
    </div>
    <div style="grid-column:span 9;display:flex;gap:8px;align-items:end">
      <input id="agentSearch" placeholder="Recherche (matricule, NOM, prénom)"/>
      <button class="btn" id="btnExportAgents">Export JSON</button>
      <input type="file" id="importAgentsFile" class="print-hide"/>
      <button class="btn" id="btnImportAgents">Import JSON</button>
    </div>
  </div>
  <div class="card grid" style="grid-template-columns:repeat(12,1fr)">
    <div style="grid-column:span 5">
      <table class="table" id="tblAgents">
        <thead><tr><th>Matricule</th><th>Nom</th><th>Prénom</th><th>Contrat</th><th></th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="grid-column:span 7">
      <h3 style="margin:0 0 8px 0">Fiche agent</h3>
      <div class="grid" style="grid-template-columns:repeat(12,1fr)">
        <div style="grid-column:span 3"><label>Matricule</label><input id="f-mat"></div>
        <div style="grid-column:span 3"><label>Nom</label><input id="f-last"></div>
        <div style="grid-column:span 3"><label>Prénom</label><input id="f-first"></div>
        <div style="grid-column:span 3"><label>Agence</label><select id="f-agency"></select></div>
        <div style="grid-column:span 3"><label>Contrat</label><select id="f-ctype"><option value="heures">Heures</option><option value="forfait_jour">Forfait-jour</option></select></div>
        <div style="grid-column:span 3"><label>Heures/sem</label><input id="f-ch" type="number" value="44"></div>
        <div style="grid-column:span 3"><label>Jours/sem</label><input id="f-cd" type="number" value="6"></div>
        <div style="grid-column:span 12"><label>Adresse</label><input id="f-addr"></div>
        <div style="grid-column:span 4"><label>Téléphone</label><input id="f-tel"></div>
        <div style="grid-column:span 4"><label>CNSS</label><input id="f-cnss"></div>
        <div style="grid-column:span 4"><label>CIN</label><input id="f-cin"></div>
        <div style="grid-column:span 12" class="flex">
          <button class="btn" id="btnNewAgent">Nouveau</button>
          <button class="btn" id="btnSaveAgent">Enregistrer</button>
          <button class="btn warn" id="btnDeleteAgent">Archiver</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- PLANIFICATION -->
<section id="planning">
  <h2>Planification</h2>
  <div class="card grid" style="grid-template-columns:repeat(12,1fr)">
    <div style="grid-column:span 3">
      <label>Agence</label>
      <select id="p-agency"></select>
    </div>
    <div style="grid-column:span 3">
      <label>Site</label>
      <select id="p-site"></select>
    </div>
    <div style="grid-column:span 3">
      <label>Mois (2025-2040)</label>
      <div class="flex">
        <button class="btn" id="p-prev">◀</button>
        <select id="p-month" style="min-width:210px"></select>
        <button class="btn" id="p-next">▶</button>
      </div>
    </div>
    <div style="grid-column:span 3">
      <label>Jours fériés (global)</label>
      <input id="p-jf" placeholder="2025-01-01,2025-05-01">
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0">Profils de prestation — Récap</h3>
    <div id="recap" class="recap-grid"></div>
  </div>

  <div class="grid" style="grid-template-columns:360px 1fr">
    <div class="card left print-hide">
      <h3 style="margin-top:0">Agents (mensuel & hebdo)</h3>
      <div id="p-agents"></div>
    </div>
    <div class="card month">
      <div class="head" id="p-head"></div>
      <div id="p-body"></div>
    </div>
  </div>

  <div class="card print-hide">
    <div class="flex">
      <button class="btn" id="btnExportCSV">Export CSV prépaie</button>
      <button class="btn" id="btnExportXLSX">Export XLSX (direct si lib présente)</button>
      <button class="btn" onclick="window.print()">Imprimer (site / mois)</button>
    </div>
    <div class="small">Astuce : clic droit sur une vacation affectée pour modifier l’horaire, poser une dérogation ou désaffecter.</div>
  </div>
</section>

<!-- INTERNET -->
<section id="internet">
  <h2>Internet</h2>
  <div class="card">
    <h3 style="margin:0 0 8px 0">Demandes (réclamations)</h3>
    <table class="table" id="tblReq">
      <thead><tr><th>Date</th><th>Émetteur</th><th>Objet</th><th>État</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="flex">
      <input id="reqFrom" placeholder="email@client.ma"/>
      <input id="reqSubj" placeholder="Objet"/>
      <input id="reqMsg" placeholder="Message (résumé)"/>
      <button class="btn" id="btnAddReq">Ajouter</button>
    </div>
  </div>
  <div class="card">
    <h3 style="margin:0 0 8px 0">Publication des plannings</h3>
    <div class="flex">
      <button class="btn" onclick="alert('Lien public simulé. En prod, on générera une URL Firebase Storage + règle de lecture.')">Générer un lien public</button>
      <span class="small">Le lien inclura le site, le mois et une durée de validité.</span>
    </div>
  </div>
</section>

<!-- PARAMÉTRAGES -->
<section id="params">
  <h2>Paramétrages</h2>
  <div class="card grid" style="grid-template-columns:repeat(12,1fr)">
    <div style="grid-column:span 4">
      <h3>Agences</h3>
      <table class="table" id="tblAgencies"><thead><tr><th>Nom</th><th></th></tr></thead><tbody></tbody></table>
      <div class="flex"><input id="inAgency" placeholder="Ajouter agence"/><button class="btn" id="btnAddAgency">Ajouter</button></div>
    </div>
    <div style="grid-column:span 4">
      <h3>Catégories produits</h3>
      <table class="table" id="tblCats"><thead><tr><th>Nom</th><th></th></tr></thead><tbody></tbody></table>
      <div class="flex"><input id="inCat" placeholder="Ajouter catégorie"/><button class="btn" id="btnAddCat">Ajouter</button></div>
    </div>
    <div style="grid-column:span 4">
      <h3>Règles de majoration</h3>
      <div class="grid" style="grid-template-columns:repeat(12,1fr)">
        <div style="grid-column:span 12"><label><input type="checkbox" id="ruleNuit" checked/> Appliquer Nuit +25%</label></div>
        <div style="grid-column:span 12"><label><input type="checkbox" id="ruleDim" checked/> Appliquer Dimanche +50%</label></div>
        <div style="grid-column:span 12"><label><input type="checkbox" id="ruleJF" checked/> Appliquer Jours fériés +100%</label></div>
      </div>
      <div class="small">Les règles s’appliquent à l’export prépaie.</div>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px 0">Profils (prestations)</h3>
    <table class="table" id="tblProfiles">
      <thead><tr><th>Libellé</th><th>Catégorie</th><th>Horaire par défaut</th><th>Tarif (info)</th><th>Règles</th><th></th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="flex">
      <input id="inProfilLabel" placeholder="Ex. ADS JOUR"/>
      <select id="inProfilCat"></select>
      <input id="inProfilStart" placeholder="08:00" style="width:120px"/>
      <input id="inProfilEnd" placeholder="18:00" style="width:120px"/>
      <input id="inProfilTarif" placeholder="Forfait/heure (info)" style="width:180px"/>
      <label class="small"><input type="checkbox" id="inProfilNuit"/> Nuit +25%</label>
      <label class="small"><input type="checkbox" id="inProfilDim"/> Dim +50%</label>
      <label class="small"><input type="checkbox" id="inProfilJF"/> JF +100%</label>
      <button class="btn" id="btnAddProfil">Ajouter</button>
    </div>
  </div>
</section>

<!-- LOGIN MODAL -->
<div id="login">
  <div class="sheet">
    <h3 style="margin-top:0">Connexion</h3>
    <div class="grid" style="grid-template-columns:repeat(12,1fr)">
      <div style="grid-column:span 12"><label>Login</label><input id="l-user" value="admin"></div>
      <div style="grid-column:span 12"><label>Mot de passe</label><input id="l-pass" type="password" value="admin"></div>
      <div style="grid-column:span 12" class="flex"><button class="btn" id="l-btn">Se connecter</button></div>
      <div class="small">Compte par défaut : <kbd>admin</kbd> / <kbd>admin</kbd> (si base vide)</div>
    </div>
  </div>
</div>

<script>
/** ========= Store (localStorage) ========= **/
const DBKEY='CRONOS_DB_V9e12';
const dbDefault={
  agencies:[{id:'AG1',name:'CASABLANCA'},{id:'AG2',name:'RABAT'},{id:'AG3',name:'MARRAKECH'}],
  categories:['Sécurité humaine','Électronique','Formation'],
  clients:[{id:'C1',name:'ACME',agencyId:'AG1',status:'Client'}],
  sites:[{id:'S1',name:'CASABLANCA – HQ',clientId:'C1',agencyId:'AG1'}],
  profiles:[
    {id:'P1',label:'ADS JOUR',cat:'Sécurité humaine',start:'08:00',end:'18:00',tarif:'Forfait 5/7',rules:{nuit:false,dim:false,jf:false}},
    {id:'P2',label:'SSIAP1 JOUR',cat:'Sécurité humaine',start:'08:00',end:'16:00',tarif:'Heure',rules:{nuit:false,dim:false,jf:false}},
    {id:'P3',label:'SSIAP1 NUIT',cat:'Sécurité humaine',start:'16:00',end:'08:00',tarif:'Heure',rules:{nuit:true,dim:true,jf:true}}
  ],
  needs:[ // seed besoin pour demo planif
    {id:'N1',siteId:'S1',profilId:'P1',start:'08:00',end:'18:00',qty:1,mask:[1,1,1,1,1,0,0],rules:{nuit:false,dim:false,jf:false}}
  ],
  agents:[
    {id:'A1',mat:'A001',last:'Amrani',first:'Youssef',agencyId:'AG1',contractType:'heures',contractHours:44,contractDays:6},
    {id:'A2',mat:'A002',last:'Bennani',first:'Salma',agencyId:'AG2',contractType:'heures',contractHours:44,contractDays:6},
    {id:'A3',mat:'A003',last:'ElFassi',first:'Karim',agencyId:'AG3',contractType:'forfait_jour',contractHours:44,contractDays:6}
  ],
  rules:{nuit:true,dim:true,jf:true},
  holidays: ''
};
let DB = JSON.parse(localStorage.getItem(DBKEY)||'null') || dbDefault;
function saveDB(){ localStorage.setItem(DBKEY, JSON.stringify(DB)); }

/** ========= Routing / Auth ========= **/
function showSection(hash){
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nav a').forEach(a=>a.classList.remove('active'));
  const id = (hash||'#commercial').replace('#','');
  document.getElementById(id).classList.add('active');
  document.getElementById('nav-'+id).classList.add('active');
}
window.addEventListener('hashchange',()=>showSection(location.hash));
document.getElementById('btn-logout').onclick=()=>{ localStorage.removeItem('CRONOS_AUTH'); document.getElementById('login').style.display='flex'; };

const authOk = localStorage.getItem('CRONOS_AUTH')==='1';
if(!authOk){ document.getElementById('login').style.display='flex'; }
document.getElementById('l-btn').onclick=()=>{
  const u=document.getElementById('l-user').value.trim(), p=document.getElementById('l-pass').value.trim();
  if((!localStorage.getItem(DBKEY) && u==='admin' && p==='admin') || (u==='admin' && p==='admin')){
    localStorage.setItem('CRONOS_AUTH','1'); document.getElementById('login').style.display='none';
  } else alert('Identifiants invalides.');
};

/** ========= Helpers ========= **/
const $id = (id)=>document.getElementById(id);
const fmt = (d)=>d.toISOString().slice(0,10);
function toMin(h){const [hh,mm]=h.split(':').map(Number);return hh*60+mm;}
function spanMin(a,b){return (toMin(b)>=toMin(a))? toMin(b)-toMin(a) : (1440-toMin(a)+toMin(b));}
function monthDays(y,m){const s=new Date(y,m,1), e=new Date(y,m+1,0), arr=[]; for(let d=new Date(s); d<=e; d.setDate(d.getDate()+1)) arr.push(new Date(d)); return arr;}
function dayIdx(d){return d.getDay()===0?6:d.getDay()-1;} // LU=0..DI=6
function night(a,b){const s=toMin(a), e=toMin(b); const ov=(a1,a2,b1,b2)=>a1<b2&&b1<a2; return e>=s? (ov(s,e,1320,1440)||ov(s,e,0,300)) : true;}

/** ========= Commerciale ========= **/
function fillCommercialFilters(){
  // agencies
  $id('c-agency').innerHTML = DB.agencies.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
  // clients of selected agency
  const ag=$id('c-agency').value || DB.agencies[0].id; $id('c-agency').value=ag;
  const clients = DB.clients.filter(c=>c.agencyId===ag);
  $id('c-client').innerHTML = clients.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
  updateClientStatus();
  fillSitesOfClient();
  renderClientsTable();
  renderSitesTable();
  renderNeedsTable();
}
function updateClientStatus(){
  const id=$id('c-client').value; const c=DB.clients.find(x=>x.id===id); if(!c) return;
  const badge=$id('c-client-status'); badge.textContent=c.status; badge.className='tag '+(c.status==='Client'?'green':''); 
}
function fillSitesOfClient(){
  const cid=$id('c-client').value; const sites=DB.sites.filter(s=>s.clientId===cid);
  $id('c-site').innerHTML = sites.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}
function renderClientsTable(){
  const ag=$id('c-agency').value; const tb=$id('tblClients').querySelector('tbody'); tb.innerHTML='';
  DB.clients.filter(c=>c.agencyId===ag).forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.name}</td><td>${DB.agencies.find(a=>a.id===c.agencyId)?.name||''}</td><td>${c.status}</td>
                  <td class="flex"><button class="btn" data-act="toggle" data-id="${c.id}">Statut</button>
                      <button class="btn warn" data-act="del" data-id="${c.id}">Archiver</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button').forEach(b=>b.onclick=(e)=>{
    const id=e.target.dataset.id, act=e.target.dataset.act; const c=DB.clients.find(x=>x.id===id);
    if(act==='toggle'){ c.status = (c.status==='Client'?'Prospect':'Client'); saveDB(); fillCommercialFilters(); }
    if(act==='del'){ if(confirm('Archiver ce client ?')){ DB.clients = DB.clients.filter(x=>x.id!==id); DB.sites = DB.sites.filter(s=>s.clientId!==id); DB.needs = DB.needs.filter(n=> DB.sites.find(s=>s.id===n.siteId)); saveDB(); fillCommercialFilters(); } }
  });
}
function renderSitesTable(){
  const cid=$id('c-client').value; const tb=$id('tblSites').querySelector('tbody'); tb.innerHTML='';
  DB.sites.filter(s=>s.clientId===cid).forEach(s=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s.name}</td><td>${DB.agencies.find(a=>a.id===s.agencyId)?.name||''}</td>
                  <td class="flex"><button class="btn warn" data-id="${s.id}">Archiver</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button').forEach(b=>b.onclick=(e)=>{
    const id=e.target.dataset.id; if(confirm('Archiver ce site ?')){ DB.needs = DB.needs.filter(n=>n.siteId!==id); DB.sites = DB.sites.filter(x=>x.id!==id); saveDB(); fillCommercialFilters(); }
  });
}
function renderNeedsTable(){
  const cid=$id('c-client').value; const site=$id('c-site').value; const tb=$id('tblNeeds').querySelector('tbody'); tb.innerHTML='';
  DB.needs.filter(n=>!site || n.siteId===site).forEach(n=>{
    const siteName=DB.sites.find(s=>s.id===n.siteId)?.name||'';
    const prof=DB.profiles.find(p=>p.id===n.profilId);
    const days=['LU','MA','ME','JE','VE','SA','DI'].map((d,i)=> n.mask[i]?'✔️':'—').join(' ');
    const rr = n.rules||{nuit:false,dim:false,jf:false};
    const rulesTxt = `${rr.nuit?'Nuit ':'- '}/${rr.dim?'Dim ':'- '}/${rr.jf?'JF':'- '}`;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${siteName}</td><td>${prof?.label||''}</td><td>${prof?.cat||''}</td><td>${n.start}</td><td>${n.end}</td><td>${n.qty}</td><td>${days}</td><td>${rr.nuit?'✔️':'—'}</td><td>${rr.dim?'✔️':'—'}</td><td>${rr.jf?'✔️':'—'}</td>
                  <td><button class="btn warn" data-id="${n.id}">Supprimer</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button').forEach(b=>b.onclick=(e)=>{
    const id=e.target.dataset.id; if(confirm('Supprimer ce besoin ?')){ DB.needs = DB.needs.filter(x=>x.id!==id); saveDB(); renderNeedsTable(); buildPlanningRows(); drawPlanningAll(); }
  });
}
$id('btnAddClient').onclick=()=>{
  const name=$id('inClientName').value.trim(); if(!name) return;
  const ag=$id('c-agency').value;
  DB.clients.push({id:'C'+(Date.now()), name, agencyId:ag, status:$id('inClientStatus').value});
  saveDB(); $id('inClientName').value=''; fillCommercialFilters();
};
$id('btnAddSite').onclick=()=>{
  const name=$id('inSiteName').value.trim(); if(!name) return;
  const ag=$id('c-agency').value; const cid=$id('c-client').value;
  DB.sites.push({id:'S'+(Date.now()), name, clientId:cid, agencyId:ag});
  saveDB(); $id('inSiteName').value=''; fillCommercialFilters();
};
$id('btnNewNeed').onclick=()=>{
  // simple prompt-driven form
  const profId = prompt('Profil (ID ou libellé exact)\nEx: SSIAP1 JOUR', 'SSIAP1 JOUR');
  if(!profId) return;
  // find profile by label or id
  const p = DB.profiles.find(x=>x.id===profId)||DB.profiles.find(x=>x.label.toUpperCase()===profId.toUpperCase());
  if(!p){ alert('Profil introuvable. Ajoute-le dans Paramétrages > Profils.'); return; }
  const start = prompt('Début (HH:MM)', p.start)||p.start;
  const end = prompt('Fin (HH:MM)', p.end)||p.end;
  const qty = parseInt(prompt('Quantité (nb de postes en parallèle)', '1')||'1',10);
  const maskStr = prompt('Jours (LU,MA,ME,JE,VE,SA,DI) avec 1 ou 0, ex: 1,1,1,1,1,1,1', (p.label.includes('JOUR')?'1,1,1,1,1,1,1':'1,1,1,1,1,1,1'));
  const mask = (maskStr||'1,1,1,1,1,0,0').split(',').map(x=>x.trim()==='1');
  const siteId=$id('c-site').value;
  DB.needs.push({id:'N'+Date.now(), siteId, profilId:p.id, start, end, qty, mask, rules:{...DB.rules}});
  saveDB(); renderNeedsTable(); buildPlanningRows(); drawPlanningAll();
};

/** ========= Paramétrages ========= **/
function fillParams(){
  // Agencies
  const tb=$id('tblAgencies').querySelector('tbody'); tb.innerHTML='';
  DB.agencies.forEach(a=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${a.name}</td><td><button class="btn warn" data-id="${a.id}">Supprimer</button></td>`; tb.appendChild(tr);
  });
  tb.querySelectorAll('button').forEach(b=>b.onclick=(e)=>{
    const id=e.target.dataset.id; if(!confirm('Supprimer agence ?')) return;
    DB.clients = DB.clients.filter(c=>c.agencyId!==id);
    DB.sites = DB.sites.filter(s=>s.agencyId!==id);
    DB.agencies = DB.agencies.filter(a=>a.id!==id);
    saveDB(); initAll();
  });
  // Cats
  const tbc=$id('tblCats').querySelector('tbody'); tbc.innerHTML='';
  DB.categories.forEach((c,i)=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${c}</td><td><button class="btn warn" data-i="${i}">Supprimer</button></td>`; tbc.appendChild(tr);
  });
  tbc.querySelectorAll('button').forEach(b=>b.onclick=(e)=>{
    const i=parseInt(e.target.dataset.i,10); DB.categories.splice(i,1); saveDB(); fillParams();
  });
  // Rules
  $id('ruleNuit').checked=!!DB.rules.nuit; $id('ruleDim').checked=!!DB.rules.dim; $id('ruleJF').checked=!!DB.rules.jf;
  // Profiles
  $id('inProfilCat').innerHTML=DB.categories.map(c=>`<option value="${c}">${c}</option>`).join('');
  const tbp=$id('tblProfiles').querySelector('tbody'); tbp.innerHTML='';
  DB.profiles.forEach(p=>{
    const r=p.rules||{nuit:false,dim:false,jf:false};
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${p.label}</td><td>${p.cat}</td><td>${p.start}-${p.end}</td><td>${p.tarif||''}</td><td>${r.nuit?'Nuit ':''}${r.dim?'Dim ':''}${r.jf?'JF':''}</td>
                  <td><button class="btn warn" data-id="${p.id}">Supprimer</button></td>`;
    tbp.appendChild(tr);
  });
  tbp.querySelectorAll('button').forEach(b=>b.onclick=(e)=>{
    const id=e.target.dataset.id; if(!confirm('Supprimer profil ?')) return;
    DB.profiles = DB.profiles.filter(x=>x.id!==id);
    DB.needs = DB.needs.filter(n=> DB.profiles.find(p=>p.id===n.profilId));
    saveDB(); fillParams(); renderNeedsTable(); buildPlanningRows(); drawPlanningAll();
  });
}
$id('btnAddAgency').onclick=()=>{ const v=$id('inAgency').value.trim(); if(!v) return; DB.agencies.push({id:'AG'+Date.now(), name:v}); saveDB(); $id('inAgency').value=''; initAll(); };
$id('btnAddCat').onclick=()=>{ const v=$id('inCat').value.trim(); if(!v) return; DB.categories.push(v); saveDB(); $id('inCat').value=''; fillParams(); };
$id('ruleNuit').onchange=(e)=>{ DB.rules.nuit=e.target.checked; saveDB(); };
$id('ruleDim').onchange=(e)=>{ DB.rules.dim=e.target.checked; saveDB(); };
$id('ruleJF').onchange=(e)=>{ DB.rules.jf=e.target.checked; saveDB(); };
$id('btnAddProfil').onclick=()=>{
  const label=$id('inProfilLabel').value.trim(); if(!label) return;
  const p={id:'P'+Date.now(), label, cat:$id('inProfilCat').value, start:$id('inProfilStart').value||'08:00', end:$id('inProfilEnd').value||'18:00', tarif:$id('inProfilTarif').value, rules:{nuit:$id('inProfilNuit').checked, dim:$id('inProfilDim').checked, jf:$id('inProfilJF').checked}};
  DB.profiles.push(p); saveDB(); $id('inProfilLabel').value=''; fillParams();
};

/** ========= Agents (CRUD simple) ========= **/
let CUR_AGENT=null;
function fillAgentsFilters(){
  $id('a-agency').innerHTML = DB.agencies.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
  renderAgentsTable();
  $id('f-agency').innerHTML = DB.agencies.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
}
function renderAgentsTable(){
  const ag=$id('a-agency').value || DB.agencies[0].id; $id('a-agency').value=ag;
  const term=($id('agentSearch').value||'').toLowerCase();
  const tb=$id('tblAgents').querySelector('tbody'); tb.innerHTML='';
  DB.agents.filter(a=>a.agencyId===ag).filter(a=>{
    return !term || (a.mat||'').toLowerCase().includes(term) || (a.last||'').toLowerCase().includes(term) || (a.first||'').toLowerCase().includes(term);
  }).forEach(a=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${a.mat||''}</td><td>${(a.last||'').toUpperCase()}</td><td>${a.first||''}</td><td>${a.contractType==='forfait_jour'?'Forfait-jour':'Heures'}</td>
                  <td><button class="btn" data-id="${a.id}">Ouvrir</button></td>`;
    tb.appendChild(tr);
  });
  tb.querySelectorAll('button').forEach(b=>b.onclick=(e)=>openAgent(e.target.dataset.id));
}
function openAgent(id){
  const a=DB.agents.find(x=>x.id===id); if(!a) return;
  CUR_AGENT=a;
  $id('f-mat').value=a.mat||''; $id('f-last').value=a.last||''; $id('f-first').value=a.first||''; $id('f-agency').value=a.agencyId||DB.agencies[0].id;
  $id('f-ctype').value=a.contractType||'heures'; $id('f-ch').value=a.contractHours||44; $id('f-cd').value=a.contractDays||6;
  $id('f-addr').value=a.addr||''; $id('f-tel').value=a.tel||''; $id('f-cnss').value=a.cnss||''; $id('f-cin').value=a.cin||'';
}
$id('btnNewAgent').onclick=()=>{ CUR_AGENT=null; ['f-mat','f-last','f-first','f-addr','f-tel','f-cnss','f-cin'].forEach(id=> $id(id).value=''); $id('f-ctype').value='heures'; $id('f-ch').value=44; $id('f-cd').value=6; };
$id('btnSaveAgent').onclick=()=>{
  const a=CUR_AGENT||{id:'A'+Date.now()};
  a.mat=$id('f-mat').value; a.last=$id('f-last').value; a.first=$id('f-first').value; a.agencyId=$id('f-agency').value;
  a.contractType=$id('f-ctype').value; a.contractHours=parseInt($id('f-ch').value||'44',10); a.contractDays=parseInt($id('f-cd').value||'6',10);
  a.addr=$id('f-addr').value; a.tel=$id('f-tel').value; a.cnss=$id('f-cnss').value; a.cin=$id('f-cin').value;
  if(!CUR_AGENT) DB.agents.push(a);
  saveDB(); renderAgentsTable(); alert('Agent enregistré.');
};
$id('btnDeleteAgent').onclick=()=>{
  if(!CUR_AGENT) return; if(!confirm('Archiver cet agent ?')) return;
  DB.agents = DB.agents.filter(x=>x.id!==CUR_AGENT.id); CUR_AGENT=null; saveDB(); renderAgentsTable();
};
$id('btnExportAgents').onclick=()=>{
  const blob=new Blob([JSON.stringify(DB.agents,null,2)],{type:'application/json'});
  const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='agents_CRONOS.json'; a.click(); URL.revokeObjectURL(url);
};
$id('btnImportAgents').onclick=()=> $id('importAgentsFile').click();
$id('importAgentsFile').addEventListener('change', (ev)=>{
  const file=ev.target.files[0]; if(!file) return;
  const fr=new FileReader(); fr.onload=()=>{ try{ const arr=JSON.parse(fr.result); if(Array.isArray(arr)){ DB.agents = arr; saveDB(); renderAgentsTable(); alert('Import réussi.'); } else alert('Format JSON invalide.'); }catch(e){ alert('Erreur import : '+e.message); } }; fr.readAsText(file);
});

/** ========= Planification (dépend des Besoins) ========= **/
let PLAN={}, OVERRIDE={};
let CUR_Y=2025, CUR_M=1;
function fillPlanningFilters(){
  $id('p-agency').innerHTML = DB.agencies.map(a=>`<option value="${a.id}">${a.name}</option>`).join('');
  const ag=$id('p-agency').value || DB.agencies[0].id; $id('p-agency').value=ag;
  const sites=DB.sites.filter(s=>s.agencyId===ag);
  $id('p-site').innerHTML = sites.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  // month picker
  const sel=$id('p-month'); sel.innerHTML=''; const now=new Date(); CUR_Y=Math.max(2025, now.getFullYear()); CUR_M=now.getMonth()+1;
  for(let y=2025;y<=2040;y++) for(let m=1;m<=12;m++){ const o=document.createElement('option'); o.value=`${y}-${String(m).padStart(2,'0')}`; o.textContent=new Date(y,m-1,1).toLocaleString('fr-FR',{month:'long',year:'numeric'}); if(y===CUR_Y&&m===CUR_M) o.selected=true; sel.appendChild(o); }
  $id('p-prev').onclick=()=>{ let y=CUR_Y,m=CUR_M-1; if(m<1){y--;m=12} if(y<2025) return; CUR_Y=y; CUR_M=m; sel.value=`${y}-${String(m).padStart(2,'0')}`; drawPlanningAll(); };
  $id('p-next').onclick=()=>{ let y=CUR_Y,m=CUR_M+1; if(m>12){y++;m=1} if(y>2040) return; CUR_Y=y; CUR_M=m; sel.value=`${y}-${String(m).padStart(2,'0')}`; drawPlanningAll(); };
}
$id('p-month').onchange=(e)=>{ const [y,m]=e.target.value.split('-').map(Number); CUR_Y=y; CUR_M=m; drawPlanningAll(); };
$id('p-agency').onchange=()=>{ fillPlanningFilters(); buildPlanningRows(); drawPlanningAll(); };
$id('p-site').onchange=()=>{ buildPlanningRows(); drawPlanningAll(); };
$id('p-jf').value = DB.holidays||'';
$id('p-jf').onchange=(e)=>{ DB.holidays=e.target.value; saveDB(); };

function buildPlanningRows(){
  // Build ROWS map from needs for selected site
  const site=$id('p-site').value; const needs = DB.needs.filter(n=>n.siteId===site);
  window.ROWS = {}; window.ROWS[site] = [];
  needs.forEach(n=>{
    for(let i=0;i<n.qty;i++){
      window.ROWS[site].push({
        id: n.id + '_'+i,
        profil: DB.profiles.find(p=>p.id===n.profilId)?.label || 'Profil',
        activite: DB.profiles.find(p=>p.id===n.profilId)?.cat || '',
        start: n.start, end: n.end, nb:1, mask:n.mask, color: n.start < n.end ? 'yellow':'blue'
      });
    }
  });
}
function drawHead(){
  const days=monthDays(CUR_Y,CUR_M-1); const h=$id('p-head'); let html=`<div>Profil · Vacation</div>`; html += days.map(d=>`<div>${d.getDate()}</div>`).join(''); h.innerHTML=html;
}
function allowDrop(e){ e.preventDefault(); e.currentTarget.classList.add('drop'); }
function leaveDrop(e){ e.currentTarget.classList.remove('drop'); }
function siteAgents(siteId){ const agId=DB.sites.find(s=>s.id===siteId)?.agencyId; return DB.agents.filter(a=>a.agencyId===agId); }
function hasIssues(agent, siteId, date, st, en){
  // build list across this site only (inter-sites à étendre si besoin)
  const list=[];
  Object.keys(PLAN).forEach(k=>{
    const [s,rowId,ds]=k.split('|'); if(PLAN[k]!==agent.id) return;
    const r=(window.ROWS[s]||[]).find(rr=>rr.id===rowId); if(!r) return;
    const d=new Date(ds);
    const ov=OVERRIDE[k]||{}; const a=ov.start||r.start; const b=ov.end||r.end;
    const stD=new Date(d.getFullYear(),d.getMonth(),d.getDate(),parseInt(a),parseInt(a.slice(3)));
    let enD=new Date(d.getFullYear(),d.getMonth(),d.getDate(),parseInt(b),parseInt(b.slice(3))); if(toMin(b)<=toMin(a)) enD.setDate(enD.getDate()+1);
    list.push({start:stD,end:enD});
  });
  const stD=new Date(date.getFullYear(),date.getMonth(),date.getDate(),parseInt(st),parseInt(st.slice(3))); let enD=new Date(date.getFullYear(),date.getMonth(),date.getDate(),parseInt(en),parseInt(en.slice(3))); if(toMin(en)<=toMin(st)) enD.setDate(enD.getDate()+1);
  // checks
  let overlap=false, rest=false, details=''; let prev=null,next=null;
  list.sort((a,b)=>a.start-b.start).forEach(iv=>{ if(iv.end>stD && iv.start<enD) overlap=true; if(iv.end<=stD) prev=iv; if(!next && iv.start>=enD) next=iv; });
  const need=11; if(prev){ const h=(stD-prev.end)/36e5; if(h<need){ rest=true; details+=(details?'\n':'')+`Repos avant ${h.toFixed(2)}h (<11h)`; } } if(next){ const h=(next.start-enD)/36e5; if(h<need){ rest=true; details+=(details?'\n':'')+`Repos après ${h.toFixed(2)}h (<11h)`; } }
  return {overlap,rest,details};
}
function onDropAssign(e){
  e.preventDefault(); e.currentTarget.classList.remove('drop');
  const agent=window._dragAgent; if(!agent) return;
  const key=e.currentTarget.dataset.key; const [site,rowId,ds]=key.split('|'); const d=new Date(ds);
  // check agency
  if(agent.agencyId !== DB.sites.find(s=>s.id===site).agencyId){ alert("Agent d'une autre agence : refusé."); return; }
  const row=(window.ROWS[site]||[]).find(r=>r.id===rowId);
  const check=hasIssues(agent, site, d, row.start, row.end);
  if(check.overlap||check.rest){ if(!confirm('⚠️ '+(check.details||'Contrainte détectée')+'\n\nValider quand même ?')) return; }
  PLAN[key]=agent.id; drawPlanningBody(); renderRecap();
}
function cellContext(e){
  e.preventDefault(); const key=e.currentTarget.dataset.key; if(!PLAN[key]) return;
  const [site,rowId,ds]=key.split('|'); const row=(window.ROWS[site]||[]).find(r=>r.id===rowId);
  const ov=OVERRIDE[key]||{}; const cur=`Actuel:\n - Horaire: ${ov.start&&ov.end?ov.start+'-'+ov.end:row.start+'-'+row.end}\n - Dérogation: ${ov.gapMin?ov.gapMin+' min':'(aucune)'}\n\n1) Modifier horaire\n2) Dérogation retard (minutes)\n3) Supprimer dérogation/horaire\n4) Désaffecter\n0) Annuler`;
  const resp=prompt(cur,''); if(resp===null) return;
  if(resp==='1'){ const val=prompt('Nouvelle plage horaire (HH:MM-HH:MM):',''); if(!val) return; const m=val.match(/^(\d{2}:\d{2})-(\d{2}:\d{2})$/); if(!m) return alert('Format invalide.'); OVERRIDE[key]={...(OVERRIDE[key]||{}), start:m[1], end:m[2]}; }
  else if(resp==='2'){ const v=prompt('Minutes non couvertes :','15'); if(v===null) return; const n=parseInt(v,10); if(isNaN(n)||n<0) return alert('Valeur invalide'); OVERRIDE[key]={...(OVERRIDE[key]||{}), gapMin:n}; }
  else if(resp==='3'){ delete OVERRIDE[key]; }
  else if(resp==='4'){ delete PLAN[key]; delete OVERRIDE[key]; }
  drawPlanningBody(); renderRecap();
}
function drawPlanningBody(){
  const site=$id('p-site').value; const rows=[...(window.ROWS[site]||[])]; const days=monthDays(CUR_Y,CUR_M-1);
  // sort: non affecté en haut
  rows.sort((a,b)=>{
    const c1=days.reduce((s,d)=>s+((a.mask[dayIdx(d)]) && !PLAN[`${site}|${a.id}|${fmt(d)}`]?1:0),0);
    const c2=days.reduce((s,d)=>s+((b.mask[dayIdx(d)]) && !PLAN[`${site}|${b.id}|${fmt(d)}`]?1:0),0);
    return (c2>0)-(c1>0);
  });
  const body=$id('p-body'); body.innerHTML='';
  rows.forEach(r=>{
    const header=document.createElement('div'); header.className='row-header';
    const left=document.createElement('div'); left.textContent=`${r.profil} ${r.start}-${r.end}`; header.appendChild(left);
    let na=0;
    days.forEach(d=>{
      const key=`${site}|${r.id}|${fmt(d)}`; const cell=document.createElement('div'); cell.className='cell'; cell.dataset.key=key;
      cell.addEventListener('dragover',allowDrop); cell.addEventListener('dragleave',leaveDrop); cell.addEventListener('drop',onDropAssign);
      if(r.mask[dayIdx(d)] && !PLAN[key]){ na++; cell.innerHTML=`<span class="pill na"><span>—</span><span>—</span></span>`; }
      header.appendChild(cell);
    });
    if(na>0){ const b=document.createElement('span'); b.className='badge-na'; b.textContent=`NON AFFECTÉ : ${na}`; left.appendChild(b); }
    body.appendChild(header);
    // agent rows
    siteAgents(site).forEach(a=>{
      let has=false; for(const d of days){ const key=`${site}|${r.id}|${fmt(d)}`; if(PLAN[key]===a.id){ has=true; break; } }
      if(!has) return;
      const rowA=document.createElement('div'); rowA.className='row-agent';
      const l=document.createElement('div'); l.innerHTML=`<b class="agent-link" data-id="${a.id}">${a.last.toUpperCase()} ${a.first}</b>`; rowA.appendChild(l);
      days.forEach(d=>{
        const key=`${site}|${r.id}|${fmt(d)}`; const cell=document.createElement('div'); cell.className='cell'; cell.dataset.key=key;
        if(PLAN[key]===a.id){
          const ov=OVERRIDE[key]||{}; const st=ov.start||r.start; const en=ov.end||r.end;
          cell.innerHTML=`<span class="pill ${r.color}"><span>${st}</span><span>${en}</span></span>` + (ov.gapMin?`<span class="small">- ${ov.gapMin}m</span>`:'');
          cell.addEventListener('contextmenu',cellContext);
        }
        rowA.appendChild(cell);
      });
      body.appendChild(rowA);
    });
  });
  // sidebar agents
  const list=siteAgents(site), sroot=$id('p-agents'); sroot.innerHTML='';
  const days=monthDays(CUR_Y,CUR_M-1);
  list.forEach(a=>{
    let monthH=0, monthJ=0, weekH=0, weekJ=0;
    const today=new Date(); const inMonth=(today.getFullYear()===CUR_Y && today.getMonth()===CUR_M-1);
    const refStart = inMonth? mondayStart(today) : mondayStart(new Date(CUR_Y, CUR_M-1, 15));
    const refEnd = mondayEnd(refStart);
    (window.ROWS[site]||[]).forEach(r=>{
      days.forEach(d=>{
        const key=`${site}|${r.id}|${fmt(d)}`; if(PLAN[key]!==a.id) return;
        const ov=OVERRIDE[key]||{}; const st=ov.start||r.start; const en=ov.end||r.end;
        if(a.contractType==='forfait_jour'){ monthJ+=1; if(d>=refStart&&d<=refEnd) weekJ+=1; }
        else { const h=spanMin(st,en)/60; monthH+=h; if(d>=refStart&&d<=refEnd) weekH+=h; }
      });
    });
    const card=document.createElement('div'); card.className='agent';
    const name=document.createElement('div'); name.className='name'; name.textContent=`${a.last.toUpperCase()} ${a.first} • ${a.mat}`;
    name.draggable=true; name.addEventListener('dragstart',()=>{ window._dragAgent=a; }); name.addEventListener('dragend',()=>{ window._dragAgent=null; });
    name.onclick=()=>openAgentModal(a);
    const meta=document.createElement('div'); meta.className='meta';
    meta.textContent=(a.contractType==='forfait_jour')?`Mensuel: ${monthJ} j / ${a.contractDays} • Hebdo: ${weekJ} j`:`Mensuel: ${monthH.toFixed(2)} h / ${(a.contractHours*4).toFixed(0)} • Hebdo: ${weekH.toFixed(2)} h`;
    card.appendChild(name); card.appendChild(meta); sroot.appendChild(card);
  });
  document.querySelectorAll('.agent-link').forEach(el=> el.onclick=()=>{
    const id=el.dataset.id; const a=DB.agents.find(x=>x.id===id); if(a) openAgentModal(a);
  });
}
function drawPlanningAll(){ drawHead(); drawPlanningBody(); renderRecap(); }
function renderRecap(){
  const site=$id('p-site').value; const rows=(window.ROWS[site]||[]); const root=$id('recap'); root.innerHTML='';
  const head=['Profil','Activité','Début','Fin','Pause','Nb','LU','MA','ME','JE','VE','SA','DI','Vac./sem','Affectées','Non affectées','Heures prévues (mois)','Heures affectées (mois)'];
  head.forEach(x=>{const d=document.createElement('div'); d.textContent=x; d.className='h'; root.appendChild(d); });
  const days=monthDays(CUR_Y,CUR_M-1);
  rows.forEach(r=>{
    let need=0, aff=0, hp=0, ha=0, vacSem=r.mask.reduce((s,x)=>s+(x?1:0),0)*r.nb;
    const flags=[0,0,0,0,0,0,0];
    days.forEach(d=>{
      const key=`${site}|${r.id}|${fmt(d)}`; const req=r.mask[dayIdx(d)];
      if(req){ need+=1; hp+=spanMin(r.start,r.end)/60; flags[dayIdx(d)]=1; }
      if(PLAN[key]){ aff+=1; const ov=OVERRIDE[key]||{}; const st=ov.start||r.start; const en=ov.end||r.end; ha+=spanMin(st,en)/60; }
    });
    const na=need-aff;
    const fields=[r.profil, r.activite, r.start, r.end, '—', r.nb].concat(flags.map(x=>x?'✔️':'—')).concat([vacSem, aff, na, hp.toFixed(2), ha.toFixed(2)]);
    fields.forEach(x=>{const d=document.createElement('div'); d.textContent=x; root.appendChild(d);});
  });
}
function mondayStart(d){ const x=new Date(d); const day=x.getDay(); const diff=(day===1?0:(day===0?-6:1-day)); x.setDate(x.getDate()+diff); x.setHours(0,0,0,0); return x; }
function mondayEnd(d){ const s=mondayStart(d); const e=new Date(s); e.setDate(e.getDate()+6); e.setHours(23,59,59,999); return e; }

/** ========= Export prépaie ========= **/
function exportCSV(){
  const site=$id('p-site').value; const days=monthDays(CUR_Y,CUR_M-1); const rows=window.ROWS[site]||[];
  const lines=[['Date','Jour','Site','Profil/Vacation','Agent','Matricule','Contrat','Horaire','Heures']];
  rows.forEach(r=>{
    days.forEach(d=>{
      const key=`${site}|${r.id}|${fmt(d)}`; const aid=PLAN[key]; if(!aid) return;
      const a=DB.agents.find(x=>x.id===aid); const ov=OVERRIDE[key]||{}; const st=ov.start||r.start; const en=ov.end||r.end;
      const mins=spanMin(st,en); const hrs=(mins/60).toFixed(2);
      const jour=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'][d.getDay()];
      lines.push([fmt(d),jour,DB.sites.find(s=>s.id===site).name,`${r.profil} ${r.start}-${r.end}`,`${(a.last||'').toUpperCase()} ${a.first||''}`,a.mat,(a.contractType==='forfait_jour'?'FORFAIT_JOUR':'HEURES'),`${st}-${en}`,hrs]);
    });
  });
  const csv=lines.map(l=>l.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(';')).join('\r\n');
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=`CRONOS_prepaie_${$id('p-month').value}_${DB.sites.find(s=>s.id===$id('p-site').value).name.replace(/\s+/g,'_')}.csv`; a.click(); URL.revokeObjectURL(url);
}
$id('btnExportCSV').onclick=exportCSV;
// XLSX direct si lib dispo (SheetJS)
function exportXLSX(){
  if(typeof XLSX==='undefined'){ alert("Librairie XLSX absente — export CSV lancé."); exportCSV(); return; }
  const site=$id('p-site').value; const days=monthDays(CUR_Y,CUR_M-1); const rows=window.ROWS[site]||[]; const jf=new Set(($id('p-jf').value||'').split(',').map(s=>s.trim()).filter(Boolean));
  const apply={nuit:$id('ruleNuit').checked, dim:$id('ruleDim').checked, jf:$id('ruleJF').checked};
  const out=[];
  rows.forEach(r=>{
    days.forEach(d=>{
      const key=`${site}|${r.id}|${fmt(d)}`; const aid=PLAN[key]; if(!aid) return;
      const a=DB.agents.find(x=>x.id===aid); const ov=OVERRIDE[key]||{}; const st=ov.start||r.start; const en=ov.end||r.end;
      const hrs=spanMin(st,en)/60; const isDim=(d.getDay()===0), isJF=jf.has(fmt(d)), isNuit=night(st,en);
      const maj_nuit = apply.nuit && isNuit ? hrs*0.25 : 0;
      const maj_dim = apply.dim && isDim ? hrs*0.50 : 0;
      const maj_jf  = apply.jf  && isJF  ? hrs*1.00  : 0;
      out.push({Date:fmt(d), Jour:['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'][d.getDay()], Site:DB.sites.find(s=>s.id===site).name,
        Profil_Vacation:`${r.profil} ${r.start}-${r.end}`, Agent:`${(a.last||'').toUpperCase()} ${a.first||''}`, Matricule:a.mat, Contrat:(a.contractType==='forfait_jour'?'FORFAIT_JOUR':'HEURES'),
        Horaire:`${st}-${en}`, Heures_base:hrs, Nuit:isNuit, Dimanche:isDim, JF:isJF, Maj_nuit_h:maj_nuit, Maj_dim_h:maj_dim, Maj_jf_h:maj_jf, Maj_total_h:(maj_nuit+maj_dim+maj_jf), Heures_payees:(hrs+maj_nuit+maj_dim+maj_jf),
        Jour_forfait_compte: (a.contractType==='forfait_jour' ? (isJF?2:1) : 0)
      });
    });
  });
  const header=["Date","Jour","Site","Profil_Vacation","Agent","Matricule","Contrat","Horaire","Heures_base","Nuit","Dimanche","JF","Maj_nuit_h","Maj_dim_h","Maj_jf_h","Maj_total_h","Heures_payees","Jour_forfait_compte"];
  const aoa=[header].concat(out.map(r=>header.map(h=>r[h])));
  const ws=XLSX.utils.aoa_to_sheet(aoa);
  const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Lignes');
  // Totaux
  const map=new Map();
  out.forEach(r=>{
    const k=r.Agent+'|'+r.Matricule+'|'+r.Contrat;
    const o=map.get(k)||{Agent:r.Agent,Matricule:r.Matricule,Contrat:r.Contrat,Heures_base:0,Maj_nuit_h:0,Maj_dim_h:0,Maj_jf_h:0,Maj_total_h:0,Heures_payees:0,Jours_forfait:0};
    o.Heures_base+=r.Heures_base; o.Maj_nuit_h+=r.Maj_nuit_h; o.Maj_dim_h+=r.Maj_dim_h; o.Maj_jf_h+=r.Maj_jf_h; o.Maj_total_h+=r.Maj_total_h; o.Heures_payees+=r.Heures_payees; o.Jours_forfait+=r.Jour_forfait_compte; map.set(k,o);
  });
  const totHdr=["Agent","Matricule","Contrat","Heures_base","Maj_nuit_h","Maj_dim_h","Maj_jf_h","Maj_total_h","Heures_payees","Jours_forfait"];
  const totAoa=[totHdr].concat(Array.from(map.values()).map(o=>totHdr.map(h=>o[h])));
  const ws2=XLSX.utils.aoa_to_sheet(totAoa); XLSX.utils.book_append_sheet(wb, ws2, 'Totaux_agents');
  XLSX.writeFile(wb, `CRONOS_PREPAIE_${$id('p-month').value}_${DB.sites.find(s=>s.id===$id('p-site').value).name.replace(/\s+/g,'_')}.xlsx`);
}
$id('btnExportXLSX').onclick=exportXLSX);

/** ========= Internet (Demandes) ========= **/
function renderReq(){
  const tb=$id('tblReq').querySelector('tbody'); tb.innerHTML='';
  (DB.requests||[]).forEach((r,i)=>{
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${r.date}</td><td>${r.from}</td><td>${r.subj}</td><td>${r.state||'Ouvert'}</td>
      <td><button class="btn" data-i="${i}">Clore</button></td>`; tb.appendChild(tr);
  });
  tb.querySelectorAll('button').forEach(b=>b.onclick=(e)=>{ const i=parseInt(e.target.dataset.i,10); DB.requests[i].state='Clos'; saveDB(); renderReq(); });
}
$id('btnAddReq').onclick=()=>{
  const r={date:new Date().toISOString().slice(0,10), from:$id('reqFrom').value, subj:$id('reqSubj').value, msg:$id('reqMsg').value, state:'Ouvert'};
  DB.requests=DB.requests||[]; DB.requests.push(r); saveDB(); renderReq();
};

/** ========= Init ========= **/
function initAll(){
  // route
  showSection(location.hash||'#commercial');
  // fill commercial
  fillCommercialFilters();
  // params
  fillParams();
  // agents
  fillAgentsFilters();
  // planning
  fillPlanningFilters(); buildPlanningRows(); drawPlanningAll();
  // internet
  renderReq();
}
initAll();
</script>
</body>
</html>
